version: '3.8'

services:
  # Backend API (NestJS)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gemura-backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3003}
      # Connect to existing devslab Postgres on host (same as ResolveIt)
      DATABASE_URL: postgresql://${POSTGRES_USER:-devslab}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT:-5433}/${POSTGRES_DB:-gemura_db}?schema=public
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3004,http://localhost:3001}
    ports:
      # Use port 3003 for backend API (3000-3002 are in use on server)
      - "${BACKEND_PORT:-3003}:3003"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - gemura-network
    volumes:
      # Mount prisma schema for migrations
      - ./backend/prisma:/app/prisma:ro
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 5 &&
        npx prisma migrate deploy &&
        node dist/main.js
      "

networks:
  gemura-network:
    driver: bridge

