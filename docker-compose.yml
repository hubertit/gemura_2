version: '3.8'

# Local development docker-compose
# For production deployment, use: docker-compose.gemura.yml

services:
  # Backend API (NestJS)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gemura-backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3004}
      # Connect to the shared Postgres container on the same server (devslab-postgres)
      # This is the same container ResolveIt uses, on the same Docker network (devslab-network).
      DATABASE_URL: postgresql://${POSTGRES_USER:-devslab_admin}:${POSTGRES_PASSWORD:-devslab_secure_password_2024}@devslab-postgres:5432/${POSTGRES_DB:-gemura_db}?schema=public
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3005,http://localhost:3004,http://159.198.65.38:3005,http://159.198.65.38:3004}
    ports:
      # Use port 3004 for backend API (3000-3003 are in use on server)
      - "${BACKEND_PORT:-3004}:3004"
    networks:
      - devslab-network
    volumes:
      # Mount prisma schema for migrations (read-only)
      - ./backend/prisma:/app/prisma:ro
    command: >
      sh -c "
        echo 'Waiting for database connection...' &&
        sleep 10 &&
        echo 'Running Prisma migrations...' &&
        npx prisma migrate deploy &&
        echo 'Starting Gemura API...' &&
        node dist/src/main.js
      "

  # Frontend Web App (Next.js) - To be added
  # frontend:
  #   build:
  #     context: ./ui
  #     dockerfile: Dockerfile
  #   container_name: gemura-frontend
  #   restart: unless-stopped
  #   environment:
  #     NODE_ENV: production
  #     PORT: 3005
  #     NEXT_PUBLIC_API_BASE: http://159.198.65.38:3004/api
  #   ports:
  #     - "${FRONTEND_PORT:-3005}:3005"
  #   depends_on:
  #     - backend
  #   networks:
  #     - devslab-network

networks:
  devslab-network:
    external: true
    name: devslab-network

