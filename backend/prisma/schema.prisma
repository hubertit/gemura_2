// Gemura API Prisma Schema
// PostgreSQL with UUID primary keys
// Legacy numeric IDs preserved in legacy_id field for migration reference

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AccountType {
  tenant
  branch
  admin
}

enum AccountStatus {
  active
  inactive
}

enum UserStatus {
  active
  inactive
}

enum UserAccountType {
  mcc
  agent
  collector
  veterinarian
  supplier
  customer
  farmer
  owner
}

enum UserAccountRole {
  owner
  admin
  manager
  collector
  supplier
  customer
  agent
  viewer
}

enum UserAccountStatus {
  active
  inactive
}

enum KycStatus {
  pending
  verified
  rejected
}

enum RegistrationType {
  self
  referred
  onboarded
}

enum MilkSaleStatus {
  pending
  accepted
  rejected
  cancelled
  deleted
}

enum RelationshipStatus {
  active
  inactive
}

enum WalletType {
  saving
  regular
}

enum WalletStatus {
  active
  inactive
}

enum OrderStatus {
  pending
  processing
  shipped
  delivered
  cancelled
  returned
}

enum ProductStatus {
  active
  inactive
  out_of_stock
}

enum FeedPostStatus {
  active
  inactive
  deleted
}

enum FeedStoryStatus {
  active
  inactive
  expired
}

enum InteractionType {
  like
  share
  comment
  bookmark
}

enum NotificationType {
  info
  warning
  error
  success
}

enum NotificationStatus {
  unread
  read
  archived
}

enum InventorySaleBuyerType {
  supplier
  customer
  other
}

enum InventorySalePaymentStatus {
  paid
  partial
  unpaid
}

enum InventoryMovementType {
  sale_out
  adjustment_in
  adjustment_out
  purchase_in
  transfer_in
  transfer_out
}

enum InventoryMovementReferenceType {
  inventory_sale
  stock_adjustment
  purchase
  transfer
}

// ============================================
// EXISTING TABLES (25 tables)
// ============================================

model Account {
  id         String        @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?       @unique @map("legacy_id") // For migration reference
  code       String?       @unique
  name       String
  type       AccountType   @default(tenant)
  parent_id  String?       @map("parent_id") @db.Uuid
  status     AccountStatus @default(active)
  created_at DateTime      @default(now()) @map("created_at")
  updated_at DateTime      @updatedAt @map("updated_at")
  created_by String?       @map("created_by") @db.Uuid
  updated_by String?       @map("updated_by") @db.Uuid

  // Relations
  parent                Account?            @relation("AccountParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children              Account[]           @relation("AccountParent")
  user_accounts         UserAccount[]
  suppliers             SupplierCustomer[]  @relation("SupplierAccount")
  customers             SupplierCustomer[]  @relation("CustomerAccount")
  milk_sales_supplier   MilkSale[]          @relation("MilkSaleSupplier")
  milk_sales_customer   MilkSale[]          @relation("MilkSaleCustomer")
  wallets               Wallet[]
  orders                Order[]
  payroll_suppliers     PayrollSupplier[]   @relation("PayrollSupplierAccount")
  payroll_payslips      PayrollPayslip[]    @relation("PayrollPayslipSupplier")
  products              Product[]           @relation("ProductAccount")
  default_account_users User[]              @relation("UserDefaultAccount")
  inventory_sales_buyer InventorySale[]     @relation("InventorySaleBuyer") // Used for both buyer tracking and supplier debt tracking
  loans_lent            Loan[]             @relation("LoanLender")
  loans_borrowed        Loan[]             @relation("LoanBorrower")
  charges               Charge[]           @relation("ChargeCustomerAccount")
  charge_supplier_links ChargeSupplier[]   @relation("ChargeSupplierAccount")
  charge_applications_supplier ChargeApplication[] @relation("ChargeApplicationSupplier")
  payroll_runs         PayrollRun[]        @relation("PayrollRunAccount")
  created_by_user       User?               @relation("AccountCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updated_by_user       User?               @relation("AccountUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)
  api_keys              ApiKey[]

  @@index([code])
  @@index([type])
  @@index([status])
  @@index([parent_id])
  @@index([created_at])
  @@map("accounts")
}

model User {
  id                   String           @id @default(uuid()) @db.Uuid
  legacy_id            BigInt?          @unique @map("legacy_id") // For migration reference
  code                 String?          @unique
  name                 String
  phone                String?          @unique
  email                String?
  nid                  String?
  address              String?
  password_hash        String           @map("password_hash")
  token                String? // Legacy token for compatibility
  last_login           DateTime?        @map("last_login")
  last_login_ip        String?          @map("last_login_ip")
  last_login_device    String?          @map("last_login_device")
  status               UserStatus       @default(active)
  default_account_id   String?          @map("default_account_id") @db.Uuid
  province             String?
  district             String?
  sector               String?
  cell                 String?
  village              String?
  id_number            String?          @map("id_number")
  id_front_photo_url   String?          @map("id_front_photo_url")
  id_back_photo_url    String?          @map("id_back_photo_url")
  selfie_photo_url     String?          @map("selfie_photo_url")
  kyc_status           KycStatus        @default(pending) @map("kyc_status")
  kyc_verified_at      DateTime?        @map("kyc_verified_at")
  kyc_verified_by      String?          @map("kyc_verified_by") @db.Uuid
  kyc_rejection_reason String?          @map("kyc_rejection_reason")
  account_type         UserAccountType  @default(mcc) @map("account_type")
  referred_by          Int?             @map("referred_by")
  onboarded_by         Int?             @map("onboarded_by")
  referral_code        String?          @unique @map("referral_code")
  referral_count       Int              @default(0) @map("referral_count")
  onboarded_count      Int              @default(0) @map("onboarded_count")
  total_points         Int              @default(0) @map("total_points")
  available_points     Int              @default(0) @map("available_points")
  registration_type    RegistrationType @default(self) @map("registration_type")
  created_at           DateTime         @default(now()) @map("created_at")
  updated_at           DateTime         @updatedAt @map("updated_at")
  created_by           String?          @map("created_by") @db.Uuid
  updated_by           String?          @map("updated_by") @db.Uuid

  // Relations
  default_account              Account?           @relation("UserDefaultAccount", fields: [default_account_id], references: [id], onDelete: SetNull)
  user_accounts                UserAccount[]
  milk_sales_recorded          MilkSale[]         @relation("MilkSaleRecordedBy")
  created_accounts             Account[]          @relation("AccountCreatedBy")
  updated_accounts             Account[]          @relation("AccountUpdatedBy")
  created_users                User[]             @relation("UserCreatedBy")
  updated_users                User[]             @relation("UserUpdatedBy")
  created_by_user              User?              @relation("UserCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updated_by_user              User?              @relation("UserUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)
  password_resets              PasswordReset[]
  notifications                Notification[]
  feed_posts                   FeedPost[]
  feed_stories                 FeedStory[]
  feed_comments                FeedComment[]
  feed_interactions            FeedInteraction[]
  user_bookmarks               UserBookmark[]
  user_relationships_follower  UserRelationship[] @relation("UserRelationshipFollower")
  user_relationships_following UserRelationship[] @relation("UserRelationshipFollowing")
  user_points                  UserPoint[]
  user_referrals_referrer      UserReferral[]     @relation("UserReferrer")
  user_referrals_referred      UserReferral[]     @relation("UserReferred")
  user_rewards                 UserReward[]
  user_onboardings             UserOnboarding[]
  inventory_sales_created      InventorySale[]    @relation("InventorySaleCreatedBy")
  inventory_movements_created  InventoryMovement[] @relation("InventoryMovementCreatedBy")
  api_keys_created             ApiKey[]

  @@index([code])
  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([account_type])
  @@index([kyc_status])
  @@index([default_account_id])
  @@index([created_at])
  @@index([last_login])
  @@map("users")
}

model UserAccount {
  id          String            @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?           @unique @map("legacy_id") // For migration reference
  user_id     String            @map("user_id") @db.Uuid
  account_id  String            @map("account_id") @db.Uuid
  role        UserAccountRole   @default(supplier)
  permissions Json? // JSONB for permissions
  status      UserAccountStatus @default(active)
  created_at  DateTime          @default(now()) @map("created_at")
  created_by  String?           @map("created_by") @db.Uuid
  updated_by  String?           @map("updated_by") @db.Uuid

  // Relations
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@unique([user_id, account_id])
  @@index([user_id])
  @@index([account_id])
  @@index([role])
  @@index([status])
  @@map("user_accounts")
}

model SupplierCustomer {
  id                      String             @id @default(uuid()) @db.Uuid
  legacy_id               BigInt?            @unique @map("legacy_id") // For migration reference
  supplier_account_id     String             @map("supplier_account_id") @db.Uuid
  customer_account_id     String             @map("customer_account_id") @db.Uuid
  price_per_liter         Decimal            @map("price_per_liter") @db.Decimal(10, 2)
  average_supply_quantity Decimal            @default(0) @map("average_supply_quantity") @db.Decimal(10, 2)
  relationship_status     RelationshipStatus @default(active) @map("relationship_status")
  created_at              DateTime           @default(now()) @map("created_at")
  updated_at              DateTime           @updatedAt @map("updated_at")
  created_by              String?            @map("created_by") @db.Uuid
  updated_by              String?            @map("updated_by") @db.Uuid

  // Relations
  supplier_account Account @relation("SupplierAccount", fields: [supplier_account_id], references: [id], onDelete: Cascade)
  customer_account Account @relation("CustomerAccount", fields: [customer_account_id], references: [id], onDelete: Cascade)

  @@unique([supplier_account_id, customer_account_id])
  @@index([supplier_account_id])
  @@index([customer_account_id])
  @@index([relationship_status])
  @@map("suppliers_customers")
}

model MilkSale {
  id                  String         @id @default(uuid()) @db.Uuid
  legacy_id           Int?           @unique @map("legacy_id") // For migration reference
  supplier_account_id String         @map("supplier_account_id") @db.Uuid
  customer_account_id String         @map("customer_account_id") @db.Uuid
  quantity            Decimal        @db.Decimal(10, 2)
  unit_price          Decimal        @map("unit_price") @db.Decimal(10, 2)
  status              MilkSaleStatus @default(pending)
  sale_at             DateTime       @map("sale_at")
  notes               String?
  amount_paid         Decimal        @default(0) @map("amount_paid") @db.Decimal(10, 2)
  payment_status      String?        @default("unpaid") @map("payment_status")
  payment_history     Json?          @map("payment_history")
  recorded_by         String         @map("recorded_by") @db.Uuid
  created_at          DateTime       @default(now()) @map("created_at")
  updated_at          DateTime       @updatedAt @map("updated_at")
  created_by          String?        @map("created_by") @db.Uuid
  updated_by          String?        @map("updated_by") @db.Uuid

  // Relations
  supplier_account    Account             @relation("MilkSaleSupplier", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  customer_account    Account             @relation("MilkSaleCustomer", fields: [customer_account_id], references: [id], onDelete: Restrict)
  recorded_by_user    User                @relation("MilkSaleRecordedBy", fields: [recorded_by], references: [id], onDelete: Restrict)

  @@index([supplier_account_id])
  @@index([customer_account_id])
  @@index([status])
  @@index([sale_at])
  @@index([recorded_by])
  @@index([created_at])
  @@index([payment_status])
  @@map("milk_sales")
}

model Product {
  id                     String        @id @default(uuid()) @db.Uuid
  legacy_id              BigInt?       @unique @map("legacy_id") // For migration reference
  name                   String
  description            String?
  price                  Decimal       @db.Decimal(10, 2)
  stock_quantity         Int           @default(0) @map("stock_quantity")
  min_stock_level        Int?          @map("min_stock_level") // Optional: for low stock alerts
  status                 ProductStatus @default(active)
  account_id             String?       @map("account_id") @db.Uuid // Link to user's account
  inventory_item_id      String?       @map("inventory_item_id") @db.Uuid // Optional: link to predefined inventory item type
  is_listed_in_marketplace Boolean     @default(false) @map("is_listed_in_marketplace") // Whether product is listed in marketplace
  created_at             DateTime      @default(now()) @map("created_at")
  updated_at             DateTime      @updatedAt @map("updated_at")
  created_by             String?       @map("created_by") @db.Uuid
  updated_by             String?       @map("updated_by") @db.Uuid

  // Relations
  account          Account?           @relation("ProductAccount", fields: [account_id], references: [id], onDelete: SetNull)
  inventory_item   InventoryItem?     @relation(fields: [inventory_item_id], references: [id], onDelete: SetNull)
  categories       ProductCategory[]
  images           ProductImage[]
  order_items      OrderItem[]
  sales            InventorySale[]    @relation("InventorySaleProduct")
  movements        InventoryMovement[]

  @@index([status])
  @@index([created_at])
  @@index([account_id])
  @@index([inventory_item_id])
  @@index([is_listed_in_marketplace])
  @@map("products")
}

model ProductCategory {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  product_id  String   @map("product_id") @db.Uuid
  category_id String   @map("category_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([product_id, category_id])
  @@index([product_id])
  @@index([category_id])
  @@map("product_categories")
}

model ProductImage {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  product_id String   @map("product_id") @db.Uuid
  image_url  String   @map("image_url")
  is_primary Boolean  @default(false) @map("is_primary")
  sort_order Int      @default(0) @map("sort_order")
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
  @@index([is_primary])
  @@map("product_images")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  name        String   @unique
  description String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  products   ProductCategory[]
  feed_posts FeedPostCategory[]

  @@index([name])
  @@map("categories")
}

model Order {
  id               String      @id @default(uuid()) @db.Uuid
  legacy_id        BigInt?     @unique @map("legacy_id") // For migration reference
  customer_id      String?     @map("customer_id") @db.Uuid
  seller_id        String?     @map("seller_id") @db.Uuid
  account_id       String      @map("account_id") @db.Uuid
  total_amount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  status           OrderStatus @default(pending)
  shipping_address String?     @map("shipping_address")
  created_at       DateTime    @default(now()) @map("created_at")
  updated_at       DateTime    @updatedAt @map("updated_at")

  // Relations
  account Account     @relation(fields: [account_id], references: [id], onDelete: Restrict)
  items   OrderItem[]
  inventory_sales InventorySale[] @relation("InventorySaleOrder")

  @@index([customer_id])
  @@index([seller_id])
  @@index([account_id])
  @@index([status])
  @@index([created_at])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  order_id   String   @map("order_id") @db.Uuid
  product_id String   @map("product_id") @db.Uuid
  quantity   Int
  price      Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  order   Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Restrict)

  @@index([order_id])
  @@index([product_id])
  @@map("order_items")
}

model Wallet {
  id         String       @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?      @unique @map("legacy_id") // For migration reference
  account_id String       @map("account_id") @db.Uuid
  code       String?      @unique
  type       WalletType   @default(regular)
  is_joint   Boolean      @default(false) @map("is_joint")
  balance    Decimal      @default(0) @db.Decimal(15, 2)
  currency   String       @default("RWF")
  status     WalletStatus @default(active)
  is_default Boolean      @default(false) @map("is_default")
  created_at DateTime     @default(now()) @map("created_at")
  updated_at DateTime     @updatedAt @map("updated_at")
  created_by String?      @map("created_by") @db.Uuid
  updated_by String?      @map("updated_by") @db.Uuid

  // Relations
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@index([code])
  @@index([status])
  @@index([is_default])
  @@map("wallets")
}

model FeedPost {
  id              String         @id @default(uuid()) @db.Uuid
  legacy_id       BigInt?        @unique @map("legacy_id") // For migration reference
  user_id         String         @map("user_id") @db.Uuid
  content         String?
  media_url       String?        @map("media_url")
  hashtags        String? // Can be JSON or comma-separated
  location        String?
  likes_count     Int            @default(0) @map("likes_count")
  shares_count    Int            @default(0) @map("shares_count")
  bookmarks_count Int            @default(0) @map("bookmarks_count")
  status          FeedPostStatus @default(active)
  created_at      DateTime       @default(now()) @map("created_at")
  updated_at      DateTime       @updatedAt @map("updated_at")
  created_by      String?        @map("created_by") @db.Uuid
  updated_by      String?        @map("updated_by") @db.Uuid

  // Relations
  user         User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  comments     FeedComment[]
  interactions FeedInteraction[]
  bookmarks    UserBookmark[]
  categories   FeedPostCategory[]

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("feed_posts")
}

model FeedStory {
  id          String          @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?         @unique @map("legacy_id") // For migration reference
  user_id     String          @map("user_id") @db.Uuid
  media_url   String?         @map("media_url")
  content     String?
  expires_at  DateTime        @map("expires_at")
  views_count Int             @default(0) @map("views_count")
  status      FeedStoryStatus @default(active)
  created_at  DateTime        @default(now()) @map("created_at")
  created_by  String?         @map("created_by") @db.Uuid
  updated_by  String?         @map("updated_by") @db.Uuid

  // Relations
  user         User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  interactions FeedInteraction[]

  @@index([user_id])
  @@index([status])
  @@index([expires_at])
  @@index([created_at])
  @@map("feed_stories")
}

model FeedComment {
  id                String         @id @default(uuid()) @db.Uuid
  legacy_id         BigInt?        @unique @map("legacy_id") // For migration reference
  post_id           String         @map("post_id") @db.Uuid
  user_id           String         @map("user_id") @db.Uuid
  parent_comment_id String?        @map("parent_comment_id") @db.Uuid
  content           String
  likes_count       Int            @default(0) @map("likes_count")
  status            FeedPostStatus @default(active)
  created_at        DateTime       @default(now()) @map("created_at")
  updated_at        DateTime       @updatedAt @map("updated_at")

  // Relations
  post           FeedPost      @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  parent_comment FeedComment?  @relation("CommentReplies", fields: [parent_comment_id], references: [id], onDelete: Cascade)
  replies        FeedComment[] @relation("CommentReplies")

  @@index([post_id])
  @@index([user_id])
  @@index([parent_comment_id])
  @@index([created_at])
  @@map("feed_comments")
}

model FeedInteraction {
  id               String          @id @default(uuid()) @db.Uuid
  legacy_id        BigInt?         @unique @map("legacy_id") // For migration reference
  user_id          String          @map("user_id") @db.Uuid
  post_id          String?         @map("post_id") @db.Uuid
  story_id         String?         @map("story_id") @db.Uuid
  interaction_type InteractionType @map("interaction_type")
  created_at       DateTime        @default(now()) @map("created_at")

  // Relations
  user  User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post  FeedPost?  @relation(fields: [post_id], references: [id], onDelete: Cascade)
  story FeedStory? @relation(fields: [story_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([post_id])
  @@index([story_id])
  @@index([interaction_type])
  @@index([created_at])
  @@map("feed_interactions")
}

model FeedPostCategory {
  id          String   @id @default(uuid()) @db.Uuid
  post_id     String   @map("post_id") @db.Uuid
  category_id String   @map("category_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  post     FeedPost @relation(fields: [post_id], references: [id], onDelete: Cascade)
  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([post_id, category_id])
  @@index([post_id])
  @@index([category_id])
  @@map("feed_post_categories")
}

model UserBookmark {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  post_id    String   @map("post_id") @db.Uuid
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  user User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post FeedPost @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id])
  @@index([user_id])
  @@index([post_id])
  @@map("user_bookmarks")
}

model UserRelationship {
  id           String   @id @default(uuid()) @db.Uuid
  legacy_id    BigInt?  @unique @map("legacy_id") // For migration reference
  follower_id  String   @map("follower_id") @db.Uuid
  following_id String   @map("following_id") @db.Uuid
  created_at   DateTime @default(now()) @map("created_at")

  // Relations
  follower  User @relation("UserRelationshipFollower", fields: [follower_id], references: [id], onDelete: Cascade)
  following User @relation("UserRelationshipFollowing", fields: [following_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
  @@map("user_relationships")
}

model Notification {
  id         String             @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?            @unique @map("legacy_id") // For migration reference
  user_id    String             @map("user_id") @db.Uuid
  title      String
  message    String
  type       NotificationType   @default(info)
  status     NotificationStatus @default(unread)
  read_at    DateTime?          @map("read_at")
  created_at DateTime           @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@index([type])
  @@index([created_at])
  @@map("notifications")
}

model ApiKey {
  id                 String    @id @default(uuid()) @db.Uuid
  legacy_id          BigInt?   @unique @map("legacy_id") // For migration reference
  key                String    @unique
  key_hash           String?   @map("key_hash") // SHA-256 hash for secure validation
  name               String?
  description        String?
  account_id         String?   @map("account_id") @db.Uuid // NULL = platform-wide access
  created_by_user_id String?   @map("created_by_user_id") @db.Uuid
  scopes             String[]  @default([]) // e.g., ["analytics:read", "export:read"]
  rate_limit         Int       @default(1000) @map("rate_limit") // requests per hour
  is_active          Boolean   @default(true) @map("is_active")
  expires_at         DateTime? @map("expires_at")
  last_used_at       DateTime? @map("last_used_at")
  request_count      Int       @default(0) @map("request_count") // total requests made
  created_at         DateTime  @default(now()) @map("created_at")
  updated_at         DateTime  @updatedAt @map("updated_at")

  // Relations
  account    Account? @relation(fields: [account_id], references: [id], onDelete: SetNull)
  created_by User?    @relation(fields: [created_by_user_id], references: [id], onDelete: SetNull)

  @@index([key])
  @@index([key_hash])
  @@index([is_active])
  @@index([account_id])
  @@index([created_by_user_id])
  @@map("api_keys")
}

model PasswordReset {
  id         String    @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?   @unique @map("legacy_id") // For migration reference
  user_id    String    @map("user_id") @db.Uuid
  token      String    @unique
  expires_at DateTime  @map("expires_at")
  used_at    DateTime? @map("used_at")
  created_at DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("password_resets")
}

model UserOnboarding {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  step       String
  completed  Boolean  @default(false)
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([step])
  @@map("user_onboardings")
}

model UserPoint {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  points     Int
  reason     String?
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([created_at])
  @@map("user_points")
}

model UserReferral {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  referrer_id String   @map("referrer_id") @db.Uuid
  referred_id String   @map("referred_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  referrer User @relation("UserReferrer", fields: [referrer_id], references: [id], onDelete: Cascade)
  referred User @relation("UserReferred", fields: [referred_id], references: [id], onDelete: Cascade)

  @@unique([referrer_id, referred_id])
  @@index([referrer_id])
  @@index([referred_id])
  @@map("user_referrals")
}

model UserReward {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  user_id     String   @map("user_id") @db.Uuid
  reward_type String   @map("reward_type")
  amount      Decimal? @db.Decimal(10, 2)
  points      Int?
  description String?
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([reward_type])
  @@index([created_at])
  @@map("user_rewards")
}

// ============================================
// NEW TABLES - ACCOUNTING MODULE
// ============================================

model ChartOfAccount {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique
  name         String
  account_type String   @map("account_type") // Asset, Liability, Equity, Revenue, Expense
  parent_id    String?  @map("parent_id") @db.Uuid
  is_active    Boolean  @default(true) @map("is_active")
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")

  // Relations
  parent       ChartOfAccount?              @relation("ChartOfAccountParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children     ChartOfAccount[]             @relation("ChartOfAccountParent")
  transactions AccountingTransactionEntry[]

  @@index([code])
  @@index([account_type])
  @@index([parent_id])
  @@map("chart_of_accounts")
}

model AccountingTransaction {
  id               String   @id @default(uuid()) @db.Uuid
  transaction_date DateTime @map("transaction_date")
  reference_number String?  @unique @map("reference_number")
  description      String?
  total_amount     Decimal  @map("total_amount") @db.Decimal(15, 2)
  created_at       DateTime @default(now()) @map("created_at")
  created_by       String?  @map("created_by") @db.Uuid

  // Relations
  entries         AccountingTransactionEntry[]

  @@index([transaction_date])
  @@index([reference_number])
  @@index([created_at])
  @@map("accounting_transactions")
}

model AccountingTransactionEntry {
  id             String   @id @default(uuid()) @db.Uuid
  transaction_id String   @map("transaction_id") @db.Uuid
  account_id     String   @map("account_id") @db.Uuid
  debit_amount   Decimal? @map("debit_amount") @db.Decimal(15, 2)
  credit_amount  Decimal? @map("credit_amount") @db.Decimal(15, 2)
  description    String?
  created_at     DateTime @default(now()) @map("created_at")

  // Relations
  transaction AccountingTransaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  account     ChartOfAccount        @relation(fields: [account_id], references: [id], onDelete: Restrict)

  @@index([transaction_id])
  @@index([account_id])
  @@map("accounting_transaction_entries")
}


model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  entity_type String   @map("entity_type")
  entity_id   String   @map("entity_id")
  action      String // create, update, delete, view
  user_id     String?  @map("user_id") @db.Uuid
  changes     Json? // JSONB for before/after changes
  ip_address  String?  @map("ip_address")
  user_agent  String?  @map("user_agent")
  created_at  DateTime @default(now()) @map("created_at")

  @@index([entity_type, entity_id])
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}

// ============================================
// NEW TABLES - PAYROLL MODULE
// ============================================

model PayrollSupplier {
  id                  String   @id @default(uuid()) @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  payment_terms_days  Int      @default(15) @map("payment_terms_days") // Default 15 days, but flexible
  is_active           Boolean  @default(true) @map("is_active")
  created_at          DateTime @default(now()) @map("created_at")
  updated_at          DateTime @updatedAt @map("updated_at")

  // Relations
  supplier_account Account          @relation("PayrollSupplierAccount", fields: [supplier_account_id], references: [id], onDelete: Cascade)
  payslips         PayrollPayslip[] @relation("PayrollSupplierPayslips")

  @@unique([supplier_account_id])
  @@index([supplier_account_id])
  @@index([is_active])
  @@map("payroll_suppliers")
}

model PayrollPeriod {
  id          String   @id @default(uuid()) @db.Uuid
  period_name String   @map("period_name")
  start_date  DateTime @map("start_date")
  end_date    DateTime @map("end_date")
  status      String // draft, processing, completed, closed
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  runs PayrollRun[]

  @@index([start_date])
  @@index([end_date])
  @@index([status])
  @@map("payroll_periods")
}

model PayrollRun {
  id                 String    @id @default(uuid()) @db.Uuid
  account_id         String?   @map("account_id") @db.Uuid // MCC/branch this run belongs to (null = legacy)
  period_id          String?   @map("period_id") @db.Uuid // Optional - flexible payroll generation
  run_name           String?   @map("run_name") // Custom name (e.g. "Jan 1 – Jan 31, 2025"); falls back to period or "Flexible Run"
  run_date           DateTime  @map("run_date")
  period_start       DateTime? @map("period_start") // Start date for milk sales period (flexible)
  period_end         DateTime? @map("period_end") // End date for milk sales period (flexible)
  payment_terms_days Int?      @map("payment_terms_days") // Payment terms in days (default 15, but flexible)
  total_amount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  status             String // draft, processing, completed, failed
  created_at         DateTime  @default(now()) @map("created_at")
  updated_at         DateTime  @updatedAt @map("updated_at")
  created_by         String?   @map("created_by") @db.Uuid

  // Relations
  account   Account?          @relation("PayrollRunAccount", fields: [account_id], references: [id], onDelete: Cascade)
  period   PayrollPeriod?   @relation(fields: [period_id], references: [id], onDelete: SetNull)
  payslips PayrollPayslip[]

  @@index([account_id])
  @@index([period_id])
  @@index([status])
  @@index([run_date])
  @@index([period_start])
  @@index([period_end])
  @@map("payroll_runs")
}

model PayrollPayslip {
  id                  String   @id @default(uuid()) @db.Uuid
  run_id              String   @map("run_id") @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  gross_amount        Decimal  @map("gross_amount") @db.Decimal(15, 2) // Total from milk sales
  total_deductions    Decimal  @map("total_deductions") @db.Decimal(15, 2)
  net_amount          Decimal  @map("net_amount") @db.Decimal(15, 2) // Amount to pay supplier
  milk_sales_count    Int      @default(0) @map("milk_sales_count") // Number of milk sales included
  period_start        DateTime  @map("period_start") // Start date of milk sales period
  period_end          DateTime  @map("period_end") // End date of milk sales period
  status              String    // draft, generated, paid
  payment_date        DateTime? @map("payment_date") // Date when payment was made
  paid_by             String?   @map("paid_by") @db.Uuid // User who marked as paid
  created_at          DateTime  @default(now()) @map("created_at")
  updated_at          DateTime  @updatedAt @map("updated_at")

  // Relations
  run              PayrollRun         @relation(fields: [run_id], references: [id], onDelete: Cascade)
  supplier_account Account            @relation("PayrollPayslipSupplier", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  payroll_supplier PayrollSupplier?   @relation("PayrollSupplierPayslips", fields: [payroll_supplier_id], references: [id], onDelete: SetNull)
  deductions       PayrollDeduction[]
  charge_applications ChargeApplication[]

  payroll_supplier_id String? @map("payroll_supplier_id") @db.Uuid

  @@index([run_id])
  @@index([supplier_account_id])
  @@index([status])
  @@index([period_start])
  @@index([period_end])
  @@map("payroll_payslips")
}

model PayrollDeduction {
  id               String   @id @default(uuid()) @db.Uuid
  payslip_id       String   @map("payslip_id") @db.Uuid
  deduction_type   String   @map("deduction_type") // tax, social_security, loan, loan_repayment, benefit, fee, inventory_debt
  amount           Decimal  @db.Decimal(10, 2)
  description      String?
  inventory_sale_id String?  @map("inventory_sale_id") @db.Uuid // Links to InventorySale when deduction_type=inventory_debt
  loan_id          String?  @map("loan_id") @db.Uuid // Links to Loan when deduction_type=loan_repayment
  charge_id        String?  @map("charge_id") @db.Uuid // Links to Charge when deduction_type=fee
  created_at       DateTime @default(now()) @map("created_at")

  // Relations
  payslip       PayrollPayslip @relation(fields: [payslip_id], references: [id], onDelete: Cascade)
  inventory_sale InventorySale? @relation(fields: [inventory_sale_id], references: [id], onDelete: SetNull)
  loan           Loan?          @relation(fields: [loan_id], references: [id], onDelete: SetNull)
  charge         Charge?        @relation(fields: [charge_id], references: [id], onDelete: SetNull)

  @@index([payslip_id])
  @@index([deduction_type])
  @@index([inventory_sale_id])
  @@index([loan_id])
  @@index([charge_id])
  @@map("payroll_deductions")
}

// ============================================
// CHARGES MODULE (supplier charges: one-time or recurring, all or selected)
// ============================================

model Charge {
  id                      String    @id @default(uuid()) @db.Uuid
  customer_account_id     String    @map("customer_account_id") @db.Uuid
  name                    String
  description             String?
  kind                    String    // one_time | recurring
  amount_type             String    @map("amount_type") // fixed | percentage
  amount                  Decimal   @db.Decimal(10, 2) // fixed amount or percentage (e.g. 5.00 for 5%)
  recurrence              String?   // monthly | per_payroll (for recurring only)
  apply_to_all_suppliers   Boolean   @default(true) @map("apply_to_all_suppliers")
  effective_from          DateTime?  @map("effective_from")
  effective_to            DateTime?  @map("effective_to")
  is_active               Boolean   @default(true) @map("is_active")
  created_at              DateTime  @default(now()) @map("created_at")
  updated_at              DateTime  @updatedAt @map("updated_at")
  created_by              String?   @map("created_by") @db.Uuid

  // Relations
  customer_account Account            @relation("ChargeCustomerAccount", fields: [customer_account_id], references: [id], onDelete: Cascade)
  selected_suppliers ChargeSupplier[]
  applications      ChargeApplication[]
  payroll_deductions PayrollDeduction[]

  @@index([customer_account_id])
  @@index([is_active])
  @@index([kind])
  @@index([effective_from])
  @@index([effective_to])
  @@map("charges")
}

model ChargeSupplier {
  id                  String   @id @default(uuid()) @db.Uuid
  charge_id           String   @map("charge_id") @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  created_at          DateTime @default(now()) @map("created_at")

  // Relations
  charge   Charge  @relation(fields: [charge_id], references: [id], onDelete: Cascade)
  supplier Account @relation("ChargeSupplierAccount", fields: [supplier_account_id], references: [id], onDelete: Cascade)

  @@unique([charge_id, supplier_account_id])
  @@index([charge_id])
  @@index([supplier_account_id])
  @@map("charge_suppliers")
}

model ChargeApplication {
  id                  String   @id @default(uuid()) @db.Uuid
  charge_id           String   @map("charge_id") @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  payslip_id          String   @map("payslip_id") @db.Uuid
  amount              Decimal  @db.Decimal(10, 2)
  applied_at           DateTime @default(now()) @map("applied_at")

  // Relations
  charge   Charge         @relation(fields: [charge_id], references: [id], onDelete: Cascade)
  supplier Account        @relation("ChargeApplicationSupplier", fields: [supplier_account_id], references: [id], onDelete: Cascade)
  payslip  PayrollPayslip @relation(fields: [payslip_id], references: [id], onDelete: Cascade)

  @@unique([charge_id, supplier_account_id])
  @@index([charge_id])
  @@index([supplier_account_id])
  @@index([payslip_id])
  @@map("charge_applications")
}

// ============================================
// NEW TABLES - MILK COLLECTION MODULE
// ============================================

model MilkRejectionReason {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  is_active   Boolean  @default(true) @map("is_active")
  sort_order  Int      @default(0) @map("sort_order")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  @@index([is_active])
  @@index([sort_order])
  @@map("milk_rejection_reasons")
}

// ============================================
// INVENTORY ITEM TYPES (predefined list for selection)
// ============================================

model InventoryItemCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?  @db.Text
  sort_order  Int      @default(0) @map("sort_order")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  items InventoryItem[]

  @@index([sort_order])
  @@map("inventory_item_categories")
}

model InventoryItem {
  id          String   @id @default(uuid()) @db.Uuid
  category_id String   @map("category_id") @db.Uuid
  name        String
  code        String?  // Optional short code (e.g. MILK-1L)
  unit        String?  // e.g. L, kg, pcs
  description String?  @db.Text
  is_active   Boolean  @default(true) @map("is_active")
  sort_order  Int      @default(0) @map("sort_order")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  category InventoryItemCategory @relation(fields: [category_id], references: [id], onDelete: Restrict)
  products Product[]

  @@index([category_id])
  @@index([is_active])
  @@index([sort_order])
  @@map("inventory_items")
}

// ============================================
// INVENTORY SALES MODULE
// ============================================

model InventorySale {
  id              String                      @id @default(uuid()) @db.Uuid
  product_id      String                      @map("product_id") @db.Uuid
  order_id        String?                     @map("order_id") @db.Uuid // Nullable: Links to Order if from online marketplace
  buyer_type      InventorySaleBuyerType      @map("buyer_type")
  buyer_account_id String?                    @map("buyer_account_id") @db.Uuid // Required for 'supplier', nullable for 'customer'/'other'
  buyer_name      String?                     @map("buyer_name") // Optional for new clients
  buyer_phone     String?                     @map("buyer_phone") // Optional for new clients
  quantity        Decimal                     @db.Decimal(10, 2)
  unit_price      Decimal                     @map("unit_price") @db.Decimal(10, 2)
  total_amount    Decimal                     @map("total_amount") @db.Decimal(10, 2)
  amount_paid     Decimal                     @default(0) @map("amount_paid") @db.Decimal(10, 2)
  payment_status  InventorySalePaymentStatus  @default(unpaid) @map("payment_status")
  sale_date       DateTime                    @map("sale_date")
  notes           String?                     @db.Text
  created_at      DateTime                    @default(now()) @map("created_at")
  updated_at      DateTime                    @updatedAt @map("updated_at")
  created_by      String?                     @map("created_by") @db.Uuid

  // Relations
  product           Product                     @relation("InventorySaleProduct", fields: [product_id], references: [id], onDelete: Restrict)
  order             Order?                      @relation("InventorySaleOrder", fields: [order_id], references: [id], onDelete: SetNull) // Link to marketplace order
  buyer_account     Account?                    @relation("InventorySaleBuyer", fields: [buyer_account_id], references: [id], onDelete: SetNull) // For buyer (supplier/customer) - also used for supplier debt tracking
  created_by_user   User?                       @relation("InventorySaleCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  payroll_deductions PayrollDeduction[]          // Settled via payroll deduction when supplier owes for inventory

  @@index([product_id])
  @@index([order_id]) // For linking to marketplace orders
  @@index([buyer_account_id])
  @@index([buyer_type])
  @@index([payment_status])
  @@index([sale_date])
  @@map("inventory_sales")
}

// ============================================
// INVENTORY MOVEMENTS (audit trail for stock changes)
// ============================================

model InventoryMovement {
  id               String                         @id @default(uuid()) @db.Uuid
  product_id       String                         @map("product_id") @db.Uuid
  movement_type    InventoryMovementType          @map("movement_type")
  quantity         Int                            // Always positive; direction from movement_type
  reference_type   InventoryMovementReferenceType @map("reference_type")
  reference_id     String?                        @map("reference_id") @db.Uuid // e.g. inventory_sale.id
  description      String?                        @db.Text // e.g. "Sale to John (A_ABC)", "New shipment"
  unit_price       Decimal?                       @map("unit_price") @db.Decimal(10, 2)
  created_at       DateTime                       @default(now()) @map("created_at")
  created_by       String?                        @map("created_by") @db.Uuid

  // Relations
  product        Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  created_by_user User?  @relation("InventoryMovementCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)

  @@index([product_id])
  @@index([movement_type])
  @@index([reference_type])
  @@index([created_at])
  @@map("inventory_movements")
}

// ============================================
// LOANS MODULE (money lending – generic borrower)
// ============================================

model Loan {
  id                   String    @id @default(uuid()) @db.Uuid
  lender_account_id    String    @map("lender_account_id") @db.Uuid   // MCC / your account
  borrower_type        String    @map("borrower_type")              // supplier, customer, other
  borrower_account_id  String?   @map("borrower_account_id") @db.Uuid // Required for supplier/customer; null for other
  borrower_name        String?   @map("borrower_name")              // For "other" or display
  principal            Decimal   @db.Decimal(15, 2)
  amount_repaid        Decimal   @default(0) @map("amount_repaid") @db.Decimal(15, 2)
  currency             String    @default("RWF")
  status               String    @default("active")                // active, closed
  disbursement_date    DateTime  @map("disbursement_date")
  due_date             DateTime? @map("due_date")
  notes                String?   @db.Text
  created_at           DateTime  @default(now()) @map("created_at")
  updated_at           DateTime  @updatedAt @map("updated_at")
  created_by           String?   @map("created_by") @db.Uuid

  // Relations
  lender_account    Account             @relation("LoanLender", fields: [lender_account_id], references: [id], onDelete: Cascade)
  borrower_account  Account?            @relation("LoanBorrower", fields: [borrower_account_id], references: [id], onDelete: SetNull)
  payroll_deductions PayrollDeduction[]
  repayments        LoanRepayment[]

  @@index([lender_account_id])
  @@index([borrower_account_id])
  @@index([borrower_type])
  @@index([status])
  @@index([disbursement_date])
  @@map("loans")
}

model LoanRepayment {
  id               String   @id @default(uuid()) @db.Uuid
  loan_id          String   @map("loan_id") @db.Uuid
  amount           Decimal  @db.Decimal(15, 2)
  repayment_date   DateTime @map("repayment_date")
  notes            String?  @db.Text
  source           String   @default("direct") // direct | payroll
  created_at       DateTime @default(now()) @map("created_at")

  loan Loan @relation(fields: [loan_id], references: [id], onDelete: Cascade)

  @@index([loan_id])
  @@index([repayment_date])
  @@map("loan_repayments")
}
