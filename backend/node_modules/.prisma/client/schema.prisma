// Gemura API Prisma Schema
// PostgreSQL with UUID primary keys
// Legacy numeric IDs preserved in legacy_id field for migration reference

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AccountType {
  tenant
  branch
}

enum AccountStatus {
  active
  inactive
}

enum UserStatus {
  active
  inactive
}

enum UserAccountType {
  mcc
  agent
  collector
  veterinarian
  supplier
  customer
  farmer
  owner
}

enum UserAccountRole {
  owner
  admin
  manager
  collector
  supplier
  customer
  agent
  viewer
}

enum UserAccountStatus {
  active
  inactive
}

enum KycStatus {
  pending
  verified
  rejected
}

enum RegistrationType {
  self
  referred
  onboarded
}

enum MilkSaleStatus {
  pending
  accepted
  rejected
  cancelled
  deleted
}

enum RelationshipStatus {
  active
  inactive
}

enum WalletType {
  saving
  regular
}

enum WalletStatus {
  active
  inactive
}

enum OrderStatus {
  pending
  processing
  shipped
  delivered
  cancelled
  returned
}

enum ProductStatus {
  active
  inactive
  out_of_stock
}

enum FeedPostStatus {
  active
  inactive
  deleted
}

enum FeedStoryStatus {
  active
  inactive
  expired
}

enum InteractionType {
  like
  share
  comment
  bookmark
}

enum NotificationType {
  info
  warning
  error
  success
}

enum NotificationStatus {
  unread
  read
  archived
}

// ============================================
// EXISTING TABLES (25 tables)
// ============================================

model Account {
  id         String        @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?       @unique @map("legacy_id") // For migration reference
  code       String?       @unique
  name       String
  type       AccountType   @default(tenant)
  parent_id  String?       @map("parent_id") @db.Uuid
  status     AccountStatus @default(active)
  created_at DateTime      @default(now()) @map("created_at")
  updated_at DateTime      @updatedAt @map("updated_at")
  created_by String?       @map("created_by") @db.Uuid
  updated_by String?       @map("updated_by") @db.Uuid

  // Relations
  parent                Account?            @relation("AccountParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children              Account[]           @relation("AccountParent")
  user_accounts         UserAccount[]
  suppliers             SupplierCustomer[]  @relation("SupplierAccount")
  customers             SupplierCustomer[]  @relation("CustomerAccount")
  milk_sales_supplier   MilkSale[]          @relation("MilkSaleSupplier")
  milk_sales_customer   MilkSale[]          @relation("MilkSaleCustomer")
  wallets               Wallet[]
  orders                Order[]
  supplier_ledger       SupplierLedger[]    @relation("SupplierLedgerAccount")
  supplier_fee_rules    SupplierFeeRule[]   @relation("SupplierFeeRuleAccount")
  supplier_deductions   SupplierDeduction[] @relation("SupplierDeductionAccount")
  invoices_supplier     Invoice[]           @relation("InvoiceAccount")
  receipts_supplier     Receipt[]           @relation("ReceiptSupplierAccount")
  receipts_customer     Receipt[]           @relation("ReceiptCustomerAccount")
  payroll_employees     PayrollEmployee[]   @relation("PayrollEmployeeAccount")
  default_account_users User[]              @relation("UserDefaultAccount")
  created_by_user       User?               @relation("AccountCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updated_by_user       User?               @relation("AccountUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([type])
  @@index([status])
  @@index([parent_id])
  @@index([created_at])
  @@map("accounts")
}

model User {
  id                   String           @id @default(uuid()) @db.Uuid
  legacy_id            BigInt?          @unique @map("legacy_id") // For migration reference
  code                 String?          @unique
  name                 String
  phone                String?
  email                String?
  nid                  String?
  address              String?
  password_hash        String           @map("password_hash")
  token                String? // Legacy token for compatibility
  last_login           DateTime?        @map("last_login")
  last_login_ip        String?          @map("last_login_ip")
  last_login_device    String?          @map("last_login_device")
  status               UserStatus       @default(active)
  default_account_id   String?          @map("default_account_id") @db.Uuid
  province             String?
  district             String?
  sector               String?
  cell                 String?
  village              String?
  id_number            String?          @map("id_number")
  id_front_photo_url   String?          @map("id_front_photo_url")
  id_back_photo_url    String?          @map("id_back_photo_url")
  selfie_photo_url     String?          @map("selfie_photo_url")
  kyc_status           KycStatus        @default(pending) @map("kyc_status")
  kyc_verified_at      DateTime?        @map("kyc_verified_at")
  kyc_verified_by      String?          @map("kyc_verified_by") @db.Uuid
  kyc_rejection_reason String?          @map("kyc_rejection_reason")
  account_type         UserAccountType  @default(mcc) @map("account_type")
  referred_by          Int?             @map("referred_by")
  onboarded_by         Int?             @map("onboarded_by")
  referral_code        String?          @map("referral_code")
  referral_count       Int              @default(0) @map("referral_count")
  onboarded_count      Int              @default(0) @map("onboarded_count")
  total_points         Int              @default(0) @map("total_points")
  available_points     Int              @default(0) @map("available_points")
  registration_type    RegistrationType @default(self) @map("registration_type")
  created_at           DateTime         @default(now()) @map("created_at")
  updated_at           DateTime         @updatedAt @map("updated_at")
  created_by           String?          @map("created_by") @db.Uuid
  updated_by           String?          @map("updated_by") @db.Uuid

  // Relations
  default_account              Account?           @relation("UserDefaultAccount", fields: [default_account_id], references: [id], onDelete: SetNull)
  user_accounts                UserAccount[]
  milk_sales_recorded          MilkSale[]         @relation("MilkSaleRecordedBy")
  created_accounts             Account[]          @relation("AccountCreatedBy")
  updated_accounts             Account[]          @relation("AccountUpdatedBy")
  created_users                User[]             @relation("UserCreatedBy")
  updated_users                User[]             @relation("UserUpdatedBy")
  created_by_user              User?              @relation("UserCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updated_by_user              User?              @relation("UserUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)
  password_resets              PasswordReset[]
  notifications                Notification[]
  feed_posts                   FeedPost[]
  feed_stories                 FeedStory[]
  feed_comments                FeedComment[]
  feed_interactions            FeedInteraction[]
  user_bookmarks               UserBookmark[]
  user_relationships_follower  UserRelationship[] @relation("UserRelationshipFollower")
  user_relationships_following UserRelationship[] @relation("UserRelationshipFollowing")
  user_points                  UserPoint[]
  user_referrals_referrer      UserReferral[]     @relation("UserReferrer")
  user_referrals_referred      UserReferral[]     @relation("UserReferred")
  user_rewards                 UserReward[]
  user_onboardings             UserOnboarding[]
  payroll_employees            PayrollEmployee[]  @relation("PayrollEmployeeUser")

  @@index([code])
  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([account_type])
  @@index([kyc_status])
  @@index([default_account_id])
  @@index([created_at])
  @@index([last_login])
  @@map("users")
}

model UserAccount {
  id          String            @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?           @unique @map("legacy_id") // For migration reference
  user_id     String            @map("user_id") @db.Uuid
  account_id  String            @map("account_id") @db.Uuid
  role        UserAccountRole   @default(supplier)
  permissions Json? // JSONB for permissions
  status      UserAccountStatus @default(active)
  created_at  DateTime          @default(now()) @map("created_at")
  created_by  String?           @map("created_by") @db.Uuid
  updated_by  String?           @map("updated_by") @db.Uuid

  // Relations
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@unique([user_id, account_id])
  @@index([user_id])
  @@index([account_id])
  @@index([role])
  @@index([status])
  @@map("user_accounts")
}

model SupplierCustomer {
  id                      String             @id @default(uuid()) @db.Uuid
  legacy_id               BigInt?            @unique @map("legacy_id") // For migration reference
  supplier_account_id     String             @map("supplier_account_id") @db.Uuid
  customer_account_id     String             @map("customer_account_id") @db.Uuid
  price_per_liter         Decimal            @map("price_per_liter") @db.Decimal(10, 2)
  average_supply_quantity Decimal            @default(0) @map("average_supply_quantity") @db.Decimal(10, 2)
  relationship_status     RelationshipStatus @default(active) @map("relationship_status")
  created_at              DateTime           @default(now()) @map("created_at")
  updated_at              DateTime           @updatedAt @map("updated_at")
  created_by              String?            @map("created_by") @db.Uuid
  updated_by              String?            @map("updated_by") @db.Uuid

  // Relations
  supplier_account Account @relation("SupplierAccount", fields: [supplier_account_id], references: [id], onDelete: Cascade)
  customer_account Account @relation("CustomerAccount", fields: [customer_account_id], references: [id], onDelete: Cascade)

  @@unique([supplier_account_id, customer_account_id])
  @@index([supplier_account_id])
  @@index([customer_account_id])
  @@index([relationship_status])
  @@map("suppliers_customers")
}

model MilkSale {
  id                  String         @id @default(uuid()) @db.Uuid
  legacy_id           Int?           @unique @map("legacy_id") // For migration reference
  supplier_account_id String         @map("supplier_account_id") @db.Uuid
  customer_account_id String         @map("customer_account_id") @db.Uuid
  quantity            Decimal        @db.Decimal(10, 2)
  unit_price          Decimal        @map("unit_price") @db.Decimal(10, 2)
  status              MilkSaleStatus @default(pending)
  sale_at             DateTime       @map("sale_at")
  notes               String?
  recorded_by         String         @map("recorded_by") @db.Uuid
  created_at          DateTime       @default(now()) @map("created_at")
  updated_at          DateTime       @updatedAt @map("updated_at")
  created_by          String?        @map("created_by") @db.Uuid
  updated_by          String?        @map("updated_by") @db.Uuid

  // Relations
  supplier_account    Account             @relation("MilkSaleSupplier", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  customer_account    Account             @relation("MilkSaleCustomer", fields: [customer_account_id], references: [id], onDelete: Restrict)
  recorded_by_user    User                @relation("MilkSaleRecordedBy", fields: [recorded_by], references: [id], onDelete: Restrict)
  supplier_ledger     SupplierLedger[]
  supplier_deductions SupplierDeduction[] @relation("SupplierDeductionMilkSale")

  @@index([supplier_account_id])
  @@index([customer_account_id])
  @@index([status])
  @@index([sale_at])
  @@index([recorded_by])
  @@index([created_at])
  @@map("milk_sales")
}

model Product {
  id             String        @id @default(uuid()) @db.Uuid
  legacy_id      BigInt?       @unique @map("legacy_id") // For migration reference
  name           String
  description    String?
  price          Decimal       @db.Decimal(10, 2)
  stock_quantity Int           @default(0) @map("stock_quantity")
  status         ProductStatus @default(active)
  created_at     DateTime      @default(now()) @map("created_at")
  updated_at     DateTime      @updatedAt @map("updated_at")
  created_by     String?       @map("created_by") @db.Uuid
  updated_by     String?       @map("updated_by") @db.Uuid

  // Relations
  categories  ProductCategory[]
  images      ProductImage[]
  order_items OrderItem[]

  @@index([status])
  @@index([created_at])
  @@map("products")
}

model ProductCategory {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  product_id  String   @map("product_id") @db.Uuid
  category_id String   @map("category_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([product_id, category_id])
  @@index([product_id])
  @@index([category_id])
  @@map("product_categories")
}

model ProductImage {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  product_id String   @map("product_id") @db.Uuid
  image_url  String   @map("image_url")
  is_primary Boolean  @default(false) @map("is_primary")
  sort_order Int      @default(0) @map("sort_order")
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
  @@index([is_primary])
  @@map("product_images")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  name        String   @unique
  description String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  products   ProductCategory[]
  feed_posts FeedPostCategory[]

  @@index([name])
  @@map("categories")
}

model Order {
  id               String      @id @default(uuid()) @db.Uuid
  legacy_id        BigInt?     @unique @map("legacy_id") // For migration reference
  customer_id      String?     @map("customer_id") @db.Uuid
  seller_id        String?     @map("seller_id") @db.Uuid
  account_id       String      @map("account_id") @db.Uuid
  total_amount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  status           OrderStatus @default(pending)
  shipping_address String?     @map("shipping_address")
  created_at       DateTime    @default(now()) @map("created_at")
  updated_at       DateTime    @updatedAt @map("updated_at")

  // Relations
  account Account     @relation(fields: [account_id], references: [id], onDelete: Restrict)
  items   OrderItem[]

  @@index([customer_id])
  @@index([seller_id])
  @@index([account_id])
  @@index([status])
  @@index([created_at])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  order_id   String   @map("order_id") @db.Uuid
  product_id String   @map("product_id") @db.Uuid
  quantity   Int
  price      Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  order   Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Restrict)

  @@index([order_id])
  @@index([product_id])
  @@map("order_items")
}

model Wallet {
  id         String       @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?      @unique @map("legacy_id") // For migration reference
  account_id String       @map("account_id") @db.Uuid
  code       String?      @unique
  type       WalletType   @default(regular)
  is_joint   Boolean      @default(false) @map("is_joint")
  balance    Decimal      @default(0) @db.Decimal(15, 2)
  currency   String       @default("RWF")
  status     WalletStatus @default(active)
  is_default Boolean      @default(false) @map("is_default")
  created_at DateTime     @default(now()) @map("created_at")
  updated_at DateTime     @updatedAt @map("updated_at")
  created_by String?      @map("created_by") @db.Uuid
  updated_by String?      @map("updated_by") @db.Uuid

  // Relations
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@index([code])
  @@index([status])
  @@index([is_default])
  @@map("wallets")
}

model FeedPost {
  id              String         @id @default(uuid()) @db.Uuid
  legacy_id       BigInt?        @unique @map("legacy_id") // For migration reference
  user_id         String         @map("user_id") @db.Uuid
  content         String?
  media_url       String?        @map("media_url")
  hashtags        String? // Can be JSON or comma-separated
  location        String?
  likes_count     Int            @default(0) @map("likes_count")
  shares_count    Int            @default(0) @map("shares_count")
  bookmarks_count Int            @default(0) @map("bookmarks_count")
  status          FeedPostStatus @default(active)
  created_at      DateTime       @default(now()) @map("created_at")
  updated_at      DateTime       @updatedAt @map("updated_at")
  created_by      String?        @map("created_by") @db.Uuid
  updated_by      String?        @map("updated_by") @db.Uuid

  // Relations
  user         User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  comments     FeedComment[]
  interactions FeedInteraction[]
  bookmarks    UserBookmark[]
  categories   FeedPostCategory[]

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("feed_posts")
}

model FeedStory {
  id          String          @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?         @unique @map("legacy_id") // For migration reference
  user_id     String          @map("user_id") @db.Uuid
  media_url   String?         @map("media_url")
  content     String?
  expires_at  DateTime        @map("expires_at")
  views_count Int             @default(0) @map("views_count")
  status      FeedStoryStatus @default(active)
  created_at  DateTime        @default(now()) @map("created_at")
  created_by  String?         @map("created_by") @db.Uuid
  updated_by  String?         @map("updated_by") @db.Uuid

  // Relations
  user         User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  interactions FeedInteraction[]

  @@index([user_id])
  @@index([status])
  @@index([expires_at])
  @@index([created_at])
  @@map("feed_stories")
}

model FeedComment {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  post_id    String   @map("post_id") @db.Uuid
  user_id    String   @map("user_id") @db.Uuid
  content    String
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  post FeedPost @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([post_id])
  @@index([user_id])
  @@index([created_at])
  @@map("feed_comments")
}

model FeedInteraction {
  id               String          @id @default(uuid()) @db.Uuid
  legacy_id        BigInt?         @unique @map("legacy_id") // For migration reference
  user_id          String          @map("user_id") @db.Uuid
  post_id          String?         @map("post_id") @db.Uuid
  story_id         String?         @map("story_id") @db.Uuid
  interaction_type InteractionType @map("interaction_type")
  created_at       DateTime        @default(now()) @map("created_at")

  // Relations
  user  User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post  FeedPost?  @relation(fields: [post_id], references: [id], onDelete: Cascade)
  story FeedStory? @relation(fields: [story_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([post_id])
  @@index([story_id])
  @@index([interaction_type])
  @@index([created_at])
  @@map("feed_interactions")
}

model FeedPostCategory {
  id          String   @id @default(uuid()) @db.Uuid
  post_id     String   @map("post_id") @db.Uuid
  category_id String   @map("category_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  post     FeedPost @relation(fields: [post_id], references: [id], onDelete: Cascade)
  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([post_id, category_id])
  @@index([post_id])
  @@index([category_id])
  @@map("feed_post_categories")
}

model UserBookmark {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  post_id    String   @map("post_id") @db.Uuid
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  user User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post FeedPost @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id])
  @@index([user_id])
  @@index([post_id])
  @@map("user_bookmarks")
}

model UserRelationship {
  id           String   @id @default(uuid()) @db.Uuid
  legacy_id    BigInt?  @unique @map("legacy_id") // For migration reference
  follower_id  String   @map("follower_id") @db.Uuid
  following_id String   @map("following_id") @db.Uuid
  created_at   DateTime @default(now()) @map("created_at")

  // Relations
  follower  User @relation("UserRelationshipFollower", fields: [follower_id], references: [id], onDelete: Cascade)
  following User @relation("UserRelationshipFollowing", fields: [following_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
  @@map("user_relationships")
}

model Notification {
  id         String             @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?            @unique @map("legacy_id") // For migration reference
  user_id    String             @map("user_id") @db.Uuid
  title      String
  message    String
  type       NotificationType   @default(info)
  status     NotificationStatus @default(unread)
  read_at    DateTime?          @map("read_at")
  created_at DateTime           @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@index([type])
  @@index([created_at])
  @@map("notifications")
}

model ApiKey {
  id         String    @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?   @unique @map("legacy_id") // For migration reference
  key        String    @unique
  name       String?
  is_active  Boolean   @default(true) @map("is_active")
  expires_at DateTime? @map("expires_at")
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime  @updatedAt @map("updated_at")

  @@index([key])
  @@index([is_active])
  @@map("api_keys")
}

model PasswordReset {
  id         String    @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?   @unique @map("legacy_id") // For migration reference
  user_id    String    @map("user_id") @db.Uuid
  token      String    @unique
  expires_at DateTime  @map("expires_at")
  used_at    DateTime? @map("used_at")
  created_at DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("password_resets")
}

model UserOnboarding {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  step       String
  completed  Boolean  @default(false)
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([step])
  @@map("user_onboardings")
}

model UserPoint {
  id         String   @id @default(uuid()) @db.Uuid
  legacy_id  BigInt?  @unique @map("legacy_id") // For migration reference
  user_id    String   @map("user_id") @db.Uuid
  points     Int
  reason     String?
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([created_at])
  @@map("user_points")
}

model UserReferral {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  referrer_id String   @map("referrer_id") @db.Uuid
  referred_id String   @map("referred_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  referrer User @relation("UserReferrer", fields: [referrer_id], references: [id], onDelete: Cascade)
  referred User @relation("UserReferred", fields: [referred_id], references: [id], onDelete: Cascade)

  @@unique([referrer_id, referred_id])
  @@index([referrer_id])
  @@index([referred_id])
  @@map("user_referrals")
}

model UserReward {
  id          String   @id @default(uuid()) @db.Uuid
  legacy_id   BigInt?  @unique @map("legacy_id") // For migration reference
  user_id     String   @map("user_id") @db.Uuid
  reward_type String   @map("reward_type")
  amount      Decimal? @db.Decimal(10, 2)
  points      Int?
  description String?
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([reward_type])
  @@index([created_at])
  @@map("user_rewards")
}

// ============================================
// NEW TABLES - ACCOUNTING MODULE
// ============================================

model ChartOfAccount {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique
  name         String
  account_type String   @map("account_type") // Asset, Liability, Equity, Revenue, Expense
  parent_id    String?  @map("parent_id") @db.Uuid
  is_active    Boolean  @default(true) @map("is_active")
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")

  // Relations
  parent       ChartOfAccount?              @relation("ChartOfAccountParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children     ChartOfAccount[]             @relation("ChartOfAccountParent")
  transactions AccountingTransactionEntry[]

  @@index([code])
  @@index([account_type])
  @@index([parent_id])
  @@map("chart_of_accounts")
}

model AccountingTransaction {
  id               String   @id @default(uuid()) @db.Uuid
  transaction_date DateTime @map("transaction_date")
  reference_number String?  @unique @map("reference_number")
  description      String?
  total_amount     Decimal  @map("total_amount") @db.Decimal(15, 2)
  created_at       DateTime @default(now()) @map("created_at")
  created_by       String?  @map("created_by") @db.Uuid

  // Relations
  entries         AccountingTransactionEntry[]
  supplier_ledger SupplierLedger[]

  @@index([transaction_date])
  @@index([reference_number])
  @@index([created_at])
  @@map("accounting_transactions")
}

model AccountingTransactionEntry {
  id             String   @id @default(uuid()) @db.Uuid
  transaction_id String   @map("transaction_id") @db.Uuid
  account_id     String   @map("account_id") @db.Uuid
  debit_amount   Decimal? @map("debit_amount") @db.Decimal(15, 2)
  credit_amount  Decimal? @map("credit_amount") @db.Decimal(15, 2)
  description    String?
  created_at     DateTime @default(now()) @map("created_at")

  // Relations
  transaction AccountingTransaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  account     ChartOfAccount        @relation(fields: [account_id], references: [id], onDelete: Restrict)

  @@index([transaction_id])
  @@index([account_id])
  @@map("accounting_transaction_entries")
}

model SupplierLedger {
  id                  String   @id @default(uuid()) @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  transaction_id      String?  @map("transaction_id") @db.Uuid
  milk_sale_id        String?  @map("milk_sale_id") @db.Uuid
  entry_type          String   @map("entry_type") // payment, collection, adjustment, fee, deduction
  amount              Decimal  @db.Decimal(15, 2)
  balance             Decimal  @db.Decimal(15, 2)
  description         String?
  created_at          DateTime @default(now()) @map("created_at")

  // Relations
  supplier_account Account                @relation("SupplierLedgerAccount", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  transaction      AccountingTransaction? @relation(fields: [transaction_id], references: [id], onDelete: SetNull)
  milk_sale        MilkSale?              @relation(fields: [milk_sale_id], references: [id], onDelete: SetNull)

  @@index([supplier_account_id])
  @@index([transaction_id])
  @@index([milk_sale_id])
  @@index([entry_type])
  @@index([created_at])
  @@map("supplier_ledger")
}

model FeeType {
  id               String   @id @default(uuid()) @db.Uuid
  code             String   @unique
  name             String
  description      String?
  fee_category     String   @map("fee_category") // collection_fee, processing_fee, service_fee, etc.
  calculation_type String   @map("calculation_type") // fixed, percentage, tiered
  is_active        Boolean  @default(true) @map("is_active")
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  // Relations
  fee_rules  SupplierFeeRule[]
  deductions SupplierDeduction[]

  @@index([code])
  @@index([fee_category])
  @@index([is_active])
  @@map("fee_types")
}

model SupplierFeeRule {
  id                  String    @id @default(uuid()) @db.Uuid
  supplier_account_id String    @map("supplier_account_id") @db.Uuid
  fee_type_id         String    @map("fee_type_id") @db.Uuid
  fixed_amount        Decimal?  @map("fixed_amount") @db.Decimal(10, 2)
  percentage          Decimal?  @db.Decimal(5, 2)
  min_amount          Decimal?  @map("min_amount") @db.Decimal(10, 2)
  max_amount          Decimal?  @map("max_amount") @db.Decimal(10, 2)
  is_active           Boolean   @default(true) @map("is_active")
  effective_from      DateTime  @map("effective_from")
  effective_to        DateTime? @map("effective_to")
  created_at          DateTime  @default(now()) @map("created_at")
  updated_at          DateTime  @updatedAt @map("updated_at")

  // Relations
  supplier_account Account @relation("SupplierFeeRuleAccount", fields: [supplier_account_id], references: [id], onDelete: Cascade)
  fee_type         FeeType @relation(fields: [fee_type_id], references: [id], onDelete: Restrict)

  @@index([supplier_account_id])
  @@index([fee_type_id])
  @@index([is_active])
  @@index([effective_from])
  @@map("supplier_fee_rules")
}

model SupplierDeduction {
  id                  String   @id @default(uuid()) @db.Uuid
  supplier_account_id String   @map("supplier_account_id") @db.Uuid
  fee_type_id         String   @map("fee_type_id") @db.Uuid
  milk_sale_id        String?  @map("milk_sale_id") @db.Uuid
  amount              Decimal  @db.Decimal(10, 2)
  description         String?
  applied_at          DateTime @map("applied_at")
  created_at          DateTime @default(now()) @map("created_at")

  // Relations
  supplier_account Account   @relation("SupplierDeductionAccount", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  fee_type         FeeType   @relation(fields: [fee_type_id], references: [id], onDelete: Restrict)
  milk_sale        MilkSale? @relation("SupplierDeductionMilkSale", fields: [milk_sale_id], references: [id], onDelete: SetNull)

  @@index([supplier_account_id])
  @@index([fee_type_id])
  @@index([milk_sale_id])
  @@index([applied_at])
  @@map("supplier_deductions")
}

model Invoice {
  id                  String    @id @default(uuid()) @db.Uuid
  invoice_number      String    @unique @map("invoice_number")
  supplier_account_id String    @map("supplier_account_id") @db.Uuid
  issue_date          DateTime  @map("issue_date")
  due_date            DateTime? @map("due_date")
  total_amount        Decimal   @map("total_amount") @db.Decimal(15, 2)
  tax_amount          Decimal?  @default(0) @map("tax_amount") @db.Decimal(15, 2)
  status              String // draft, sent, paid, overdue, cancelled
  created_at          DateTime  @default(now()) @map("created_at")
  updated_at          DateTime  @updatedAt @map("updated_at")
  created_by          String?   @map("created_by") @db.Uuid

  // Relations
  supplier_account Account       @relation("InvoiceAccount", fields: [supplier_account_id], references: [id], onDelete: Restrict)
  items            InvoiceItem[]

  @@index([invoice_number])
  @@index([supplier_account_id])
  @@index([status])
  @@index([issue_date])
  @@map("invoices")
}

model InvoiceItem {
  id           String   @id @default(uuid()) @db.Uuid
  invoice_id   String   @map("invoice_id") @db.Uuid
  description  String
  quantity     Decimal? @db.Decimal(10, 2)
  unit_price   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total_amount Decimal  @map("total_amount") @db.Decimal(10, 2)
  created_at   DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoice_id], references: [id], onDelete: Cascade)

  @@index([invoice_id])
  @@map("invoice_items")
}

model Receipt {
  id                  String   @id @default(uuid()) @db.Uuid
  receipt_number      String   @unique @map("receipt_number")
  supplier_account_id String?  @map("supplier_account_id") @db.Uuid
  customer_account_id String?  @map("customer_account_id") @db.Uuid
  payment_date        DateTime @map("payment_date")
  amount              Decimal  @db.Decimal(15, 2)
  payment_method      String?  @map("payment_method")
  reference           String?
  created_at          DateTime @default(now()) @map("created_at")
  created_by          String?  @map("created_by") @db.Uuid

  // Relations
  supplier_account Account? @relation("ReceiptSupplierAccount", fields: [supplier_account_id], references: [id], onDelete: SetNull)
  customer_account Account? @relation("ReceiptCustomerAccount", fields: [customer_account_id], references: [id], onDelete: SetNull)

  @@index([receipt_number])
  @@index([supplier_account_id])
  @@index([customer_account_id])
  @@index([payment_date])
  @@map("receipts")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  entity_type String   @map("entity_type")
  entity_id   String   @map("entity_id")
  action      String // create, update, delete, view
  user_id     String?  @map("user_id") @db.Uuid
  changes     Json? // JSONB for before/after changes
  ip_address  String?  @map("ip_address")
  user_agent  String?  @map("user_agent")
  created_at  DateTime @default(now()) @map("created_at")

  @@index([entity_type, entity_id])
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}

// ============================================
// NEW TABLES - PAYROLL MODULE
// ============================================

model PayrollEmployee {
  id              String   @id @default(uuid()) @db.Uuid
  user_id         String?  @map("user_id") @db.Uuid
  account_id      String?  @map("account_id") @db.Uuid
  employee_number String   @unique @map("employee_number")
  position        String?
  department      String?
  salary          Decimal  @db.Decimal(15, 2)
  employment_type String   @map("employment_type") // full_time, part_time, contract
  hire_date       DateTime @map("hire_date")
  is_active       Boolean  @default(true) @map("is_active")
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  user     User?            @relation("PayrollEmployeeUser", fields: [user_id], references: [id], onDelete: SetNull)
  account  Account?         @relation("PayrollEmployeeAccount", fields: [account_id], references: [id], onDelete: SetNull)
  payslips PayrollPayslip[]

  @@index([user_id])
  @@index([account_id])
  @@index([employee_number])
  @@index([is_active])
  @@map("payroll_employees")
}

model PayrollPeriod {
  id          String   @id @default(uuid()) @db.Uuid
  period_name String   @map("period_name")
  start_date  DateTime @map("start_date")
  end_date    DateTime @map("end_date")
  status      String // draft, processing, completed, closed
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  runs PayrollRun[]

  @@index([start_date])
  @@index([end_date])
  @@index([status])
  @@map("payroll_periods")
}

model PayrollRun {
  id           String   @id @default(uuid()) @db.Uuid
  period_id    String   @map("period_id") @db.Uuid
  run_date     DateTime @map("run_date")
  total_amount Decimal  @map("total_amount") @db.Decimal(15, 2)
  status       String // draft, processing, completed, failed
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  created_by   String?  @map("created_by") @db.Uuid

  // Relations
  period   PayrollPeriod    @relation(fields: [period_id], references: [id], onDelete: Cascade)
  payslips PayrollPayslip[]

  @@index([period_id])
  @@index([status])
  @@index([run_date])
  @@map("payroll_runs")
}

model PayrollPayslip {
  id               String   @id @default(uuid()) @db.Uuid
  run_id           String   @map("run_id") @db.Uuid
  employee_id      String   @map("employee_id") @db.Uuid
  gross_salary     Decimal  @map("gross_salary") @db.Decimal(15, 2)
  total_deductions Decimal  @map("total_deductions") @db.Decimal(15, 2)
  net_salary       Decimal  @map("net_salary") @db.Decimal(15, 2)
  status           String // draft, generated, paid
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  // Relations
  run        PayrollRun         @relation(fields: [run_id], references: [id], onDelete: Cascade)
  employee   PayrollEmployee    @relation(fields: [employee_id], references: [id], onDelete: Restrict)
  deductions PayrollDeduction[]

  @@index([run_id])
  @@index([employee_id])
  @@index([status])
  @@map("payroll_payslips")
}

model PayrollDeduction {
  id             String   @id @default(uuid()) @db.Uuid
  payslip_id     String   @map("payslip_id") @db.Uuid
  deduction_type String   @map("deduction_type") // tax, social_security, loan, benefit, fee
  amount         Decimal  @db.Decimal(10, 2)
  description    String?
  created_at     DateTime @default(now()) @map("created_at")

  // Relations
  payslip PayrollPayslip @relation(fields: [payslip_id], references: [id], onDelete: Cascade)

  @@index([payslip_id])
  @@index([deduction_type])
  @@map("payroll_deductions")
}
